% Commands for exam creation
% 
% (c) Anton Akhmerov (TU Delft)
%
%% All rights reserved
% 
\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{exam}
  [2017/02/10 v0.01 LaTeX package for exam creation]
\RequirePackage{zref-savepos}
% \RequirePackage{zref-abspos}
\RequirePackage{qrcode}
\RequirePackage{forloop}
\RequirePackage{fancyhdr}
\RequirePackage{calc}

\setlength{\headheight}{60pt}
\renewcommand{\headrulewidth}{0pt}
\pagestyle{fancy}
\usepackage{environ}

\makeatletter
\newcommand\dimtomm[1]{%
    \strip@pt\dimexpr 0.351459804\dimexpr#1\relax\relax%
}
\makeatother

\newwrite\problems
\openout\problems=\jobname.yml\relax

\newcommand{\examformatversion}{0}
\newcommand{\examname}{}

\newcommand{\measured}[1]{\ifthenelse{\equal{\value{copynumber}}{2}}{#1}{}}

\newcommand{\widgetbox}[2]{%
\measured{\expandafter\newcommand\csname widget#1\endcsname{}}%
\leavevmode%
\mbox{\measured{\zsavepos{ll\arabic{widgetnr}}}\mbox{#2}\measured{\zsavepos{rr\arabic{widgetnr}}}}
\measured{%
\immediate\write\problems{\space\space #1:}%
\immediate\write\problems{\space\space\space\space- page: \thepage}%
\immediate\write\problems{\space\space\space\space- \dimtomm{\zposx{ll\arabic{widgetnr}}sp}}%
\immediate\write\problems{\space\space\space\space- \dimtomm{\zposy{ll\arabic{widgetnr}}sp}}%
\immediate\write\problems{\space\space\space\space- \dimtomm{\zposx{rr\arabic{widgetnr}}sp}}%
\immediate\write\problems{\space\space\space\space- \dimtomm{\zposy{rr\arabic{widgetnr}}sp}}%
}%
\stepcounter{widgetnr}
}

\newcommand{\answerbox}[3]{\widgetbox{#1}{\fbox{\parbox[c][#2]{\textwidth}{#3\hfill}}}}
\lhead{\examname;\thepage;\arabic{copynumber}}
\rhead{\widgetbox{qrcode\thepage}{\qrcode{v\examformatversion;\examname;\thepage;\arabic{copynumber}}}}

\newcounter{copynumber}
\newcounter{widgetnr}

\NewEnviron{exam}[2]{
\ifthenelse{\equal{#2}{1}}{
\PackageError{exam}{Must make at least two exam copies}{Probably will fix someday}
}{}
\renewcommand{\examname}{#1}
\write\problems{protocol_version: \examformatversion}
\write\problems{name: \examname}
\write\problems{widgets:}
\forLoop{1}{#2}{copynumber}{
\setcounter{page}{1}
\newpage
\BODY
}
}

\endinput
%%
%% End of file `exam.sty'.
