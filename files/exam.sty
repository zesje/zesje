% Commands for exam creation
%
% Copyright 2017 zesje developers
%
%% Available under BSD-simplified license.
%
\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{exam}
  [2017/02/10 v0.01 LaTeX package for exam creation]
\RequirePackage{zref-savepos}
\RequirePackage{qrcode}
\RequirePackage{forloop}
\RequirePackage{fancyhdr}
\RequirePackage{calc}
\RequirePackage{placeins}
\RequirePackage{graphicx}
\RequirePackage{fp}
\RequirePackage{environ}
\RequirePackage{kvoptions}
\RequirePackage{tikz}
\RequirePackage{everypage}

\DeclareStringOption[exam]{name}
\DeclareStringOption[1]{copies}[1]
\ProcessKeyvalOptions*

\usetikzlibrary{calc}

\setlength{\headheight}{90pt}
\pagestyle{fancy}

\makeatletter

\newcommand*\cropmarks{%
  \begin{tikzpicture}[remember picture,overlay]
    \draw ($(current page.north east)+(-5mm,-10mm)$) -- ($(current page.north east)+(-10mm,-10mm)$);
    \draw ($(current page.north east)+(-10mm,-5mm)$) -- ($(current page.north east)+(-10mm,-10mm)$);
    \draw ($(current page.south east)+(-5mm,10mm)$) -- ($(current page.south east)+(-10mm,10mm)$);
    \draw ($(current page.south east)+(-10mm,5mm)$) -- ($(current page.south east)+(-10mm,10mm)$);
    \draw ($(current page.north west)+(5mm,-10mm)$) -- ($(current page.north west)+(10mm,-10mm)$);
    \draw ($(current page.north west)+(10mm,-5mm)$) -- ($(current page.north west)+(10mm,-10mm)$);
    \draw ($(current page.south west)+(5mm,10mm)$) -- ($(current page.south west)+(10mm,10mm)$);
    \draw ($(current page.south west)+(10mm,5mm)$) -- ($(current page.south west)+(10mm,10mm)$);
  \end{tikzpicture}%
}

\AddEverypageHook{\cropmarks}

\newcommand{\examformatversion}{1}

\immediate\newwrite\problems
\immediate\openout\problems=\jobname.yml\relax

\immediate\write\problems{protocol_version: \examformatversion}
\immediate\write\problems{name: \exam@name}
\immediate\write\problems{widgets:}



% adapted from http://tex.stackexchange.com/a/267589/51635
\def\bbox#1#2{#2\def\bboxid{#1}%
   \ifmmode \mathpalette\bboxM{#2}\else \bboxA{#2}\fi
}
\def\bboxA#1{\setbox0=\hbox{#1}\pdfsavepos\bboxB}
\def\bboxM#1#2{\setbox0=\hbox{$#1#2$}\pdfsavepos\bboxB}
\def\bboxB{\edef\tmp{%
\write\problems{\space\space - name: \bboxid}%
\write\problems{\space\space\space\space data:}%
\write\problems{\space\space\space\space\space\space page: \thepage}%
\write\problems{\space\space\space\space\space\space left: \noexpand\the\pdflastxpos - \number\wd0}%
\write\problems{\space\space\space\space\space\space bottom: \noexpand\the\pdflastypos - \number\dp0}%
\write\problems{\space\space\space\space\space\space right: \noexpand\the\pdflastxpos + 0}%
\write\problems{\space\space\space\space\space\space top: \noexpand\the\pdflastypos + \number\ht0}%
}\tmp}


\newcommand{\widgetbox}[2]{%
\ifthenelse{\equal{\value{copynumber}}{1}}{\bbox{#1}{#2}}{#2}%
}

\newcommand{\answerbox}[2]{%
\stepcounter{problemnr}%
\FloatBarrier
  \begin{figure*}[!h]
\widgetbox{question_\arabic{problemnr}}{\fbox{\parbox[c][#1]{\textwidth}{#2\hfill}}}
  \end{figure*}
\FloatBarrier
}

\lhead{Exam: \exam@name, Copy: \arabic{copynumber}, Page: \thepage}
\rhead{\raisebox{10pt}{\widgetbox{qrcode\thepage}{\qrcode[height=60pt]{v\examformatversion;\exam@name;\thepage;\arabic{copynumber}}}}}

\immediate\newcounter{copynumber}
\newcounter{problemnr}

\newcommand{\header}{%
\noindent\textbf{Fill out your student number, your name, and your family name below. Only provide answers inside the answer boxes.}\\
\vspace{.1cm}\\
\ifthenelse{\equal{\thepage}{1}}{\widgetbox{studentnr}{\includegraphics[height=100pt]{number_widget}}}{}
}

\NewEnviron{exam}{
\forLoop{1}{\exam@copies}{copynumber}{
\setcounter{page}{1}
\BODY

\cleardoublepage
}
}

\endinput
%%
%% End of file `exam.sty'.
